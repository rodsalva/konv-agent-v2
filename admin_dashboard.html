<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MercadoLivre AI Agent Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header h1 {
            color: white;
            font-size: 28px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 10px;
        }

        .header p {
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            font-size: 16px;
        }

        .main-content {
            padding: 30px 0;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 6px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }

        .btn-premium {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }

        .btn-premium:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            display: block;
        }

        .metric-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .output-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #333;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .output-title {
            color: #00ff00;
            font-size: 16px;
            font-weight: 600;
        }

        .output-container {
            background: #000;
            border-radius: 8px;
            padding: 20px;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            line-height: 1.4;
            border: 1px solid #333;
        }

        .output-line {
            color: #00ff00;
            margin: 2px 0;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .output-line.info { color: #00bfff; }
        .output-line.success { color: #00ff00; }
        .output-line.warning { color: #ffaa00; }
        .output-line.error { color: #ff4444; }

        .personas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .persona-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .persona-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .persona-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .persona-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
            line-height: 1.4;
            font-style: italic;
        }

        .persona-name {
            font-size: 18px;
            font-weight: 600;
        }

        .persona-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-waiting { background: rgba(255, 255, 255, 0.2); }
        .status-active { background: #4CAF50; }
        .status-completed { background: #2196F3; }

        .persona-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .persona-stat {
            text-align: center;
        }

        .persona-stat-value {
            font-size: 20px;
            font-weight: 700;
            display: block;
        }

        .persona-stat-label {
            font-size: 11px;
            opacity: 0.8;
            text-transform: uppercase;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-offline { background-color: #ff4444; }
        .status-online { background-color: #00ff00; }
        .status-running { background-color: #ffaa00; animation: pulse 1.5s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .company-agents {
            margin-top: 30px;
        }

        .company-agent-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
            margin-bottom: 15px;
        }

        .agent-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .agent-work {
            font-size: 14px;
            opacity: 0.9;
            line-height: 1.4;
        }

        .interaction-details {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .interaction-section {
            margin-bottom: 15px;
        }

        .interaction-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .interaction-list {
            list-style: none;
            padding-left: 0;
        }

        .interaction-list li {
            padding: 4px 0;
            border-left: 3px solid #667eea;
            padding-left: 10px;
            margin: 5px 0;
        }

        .persona-summary {
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            font-size: 14px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>🛒 MercadoLivre AI Agent Admin Dashboard</h1>
            <p>Real-time monitoring and control of AI persona exploration system</p>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <div class="tabs">
                <button class="tab active" data-tab="overview">📊 Overview</button>
                <button class="tab" data-tab="output">📺 Live Output</button>
                <button class="tab" data-tab="personas">👥 Personas & Interactions</button>
                <button class="tab" data-tab="company">🏢 Company Agents</button>
                <button class="tab" data-tab="surveys">📋 Survey Results</button>
                <button class="tab" data-tab="insights">🧠 AI Insights</button>
            </div>

            <div id="overview" class="tab-content active">
                <div class="controls">
                    <button class="btn btn-premium" id="runAllBtn">
                        🚀 Run AI Agent Analysis
                    </button>
                    <button class="btn btn-danger" id="stopBtn">
                        ⏹️ Stop
                    </button>
                </div>

                <div class="metrics">
                    <div class="metric-card">
                        <span class="metric-value" id="totalPersonas">7</span>
                        <span class="metric-label">Total Personas</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value" id="activePersonas">0</span>
                        <span class="metric-label">Active Personas</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value" id="totalObservations">0</span>
                        <span class="metric-label">Observations</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value" id="runtime">0:00</span>
                        <span class="metric-label">Runtime</span>
                    </div>
                </div>

                <div class="personas-grid">
                    <div class="persona-card">
                        <div class="persona-header">
                            <div class="persona-name">🔬 Tech Enthusiast</div>
                            <div class="persona-status status-waiting" id="persona1Status">Waiting</div>
                        </div>
                        <div class="persona-description">
                            Focuses on specifications, features, and performance comparisons
                        </div>
                        <div class="persona-stats">
                            <div class="persona-stat">
                                <span class="persona-stat-value" id="persona1Obs">0</span>
                                <span class="persona-stat-label">Observations</span>
                            </div>
                            <div class="persona-stat">
                                <span class="persona-stat-value" id="persona1Time">0m</span>
                                <span class="persona-stat-label">Runtime</span>
                            </div>
                        </div>
                    </div>
                    <div class="persona-card">
                        <div class="persona-header">
                            <div class="persona-name">💰 Budget Shopper</div>
                            <div class="persona-status status-waiting" id="persona2Status">Waiting</div>
                        </div>
                        <div class="persona-description">
                            Price-conscious, seeks deals, discounts, and best value options
                        </div>
                        <div class="persona-stats">
                            <div class="persona-stat">
                                <span class="persona-stat-value" id="persona2Obs">0</span>
                                <span class="persona-stat-label">Observations</span>
                            </div>
                            <div class="persona-stat">
                                <span class="persona-stat-value" id="persona2Time">0m</span>
                                <span class="persona-stat-label">Runtime</span>
                            </div>
                        </div>
                    </div>
                    <div class="persona-card">
                        <div class="persona-header">
                            <div class="persona-name">🎁 Gift Buyer</div>
                            <div class="persona-status status-waiting" id="persona3Status">Waiting</div>
                        </div>
                        <div class="persona-description">
                            Purchases for others, values presentation and gift services
                        </div>
                        <div class="persona-stats">
                            <div class="persona-stat">
                                <span class="persona-stat-value" id="persona3Obs">0</span>
                                <span class="persona-stat-label">Observations</span>
                            </div>
                            <div class="persona-stat">
                                <span class="persona-stat-value" id="persona3Time">0m</span>
                                <span class="persona-stat-label">Runtime</span>
                            </div>
                        </div>
                    </div>
                    <div class="persona-card">
                        <div class="persona-header">
                            <div class="persona-name">👨‍👩‍👧‍👦 Family Shopper</div>
                            <div class="persona-status status-waiting" id="persona4Status">Waiting</div>
                        </div>
                        <div class="persona-description">
                            Buys for household needs, bulk purchases, safety-focused
                        </div>
                        <div class="persona-stats">
                            <div class="persona-stat">
                                <span class="persona-stat-value" id="persona4Obs">0</span>
                                <span class="persona-stat-label">Observations</span>
                            </div>
                            <div class="persona-stat">
                                <span class="persona-stat-value" id="persona4Time">0m</span>
                                <span class="persona-stat-label">Runtime</span>
                            </div>
                        </div>
                    </div>
                    <div class="persona-card">
                        <div class="persona-header">
                            <div class="persona-name">🏢 Business Buyer</div>
                            <div class="persona-status status-waiting" id="persona5Status">Waiting</div>
                        </div>
                        <div class="persona-description">
                            Professional purchases, bulk orders, B2B features needed
                        </div>
                        <div class="persona-stats">
                            <div class="persona-stat">
                                <span class="persona-stat-value" id="persona5Obs">0</span>
                                <span class="persona-stat-label">Observations</span>
                            </div>
                            <div class="persona-stat">
                                <span class="persona-stat-value" id="persona5Time">0m</span>
                                <span class="persona-stat-label">Runtime</span>
                            </div>
                        </div>
                    </div>
                    <div class="persona-card">
                        <div class="persona-header">
                            <div class="persona-name">👴 Senior Shopper</div>
                            <div class="persona-status status-waiting" id="persona6Status">Waiting</div>
                        </div>
                        <div class="persona-description">
                            Values simplicity, clear information, and customer support
                        </div>
                        <div class="persona-stats">
                            <div class="persona-stat">
                                <span class="persona-stat-value" id="persona6Obs">0</span>
                                <span class="persona-stat-label">Observations</span>
                            </div>
                            <div class="persona-stat">
                                <span class="persona-stat-value" id="persona6Time">0m</span>
                                <span class="persona-stat-label">Runtime</span>
                            </div>
                        </div>
                    </div>
                    <div class="persona-card">
                        <div class="persona-header">
                            <div class="persona-name">💎 Luxury Shopper</div>
                            <div class="persona-status status-waiting" id="persona7Status">Waiting</div>
                        </div>
                        <div class="persona-description">
                            Premium quality focused, exclusive products, premium service
                        </div>
                        <div class="persona-stats">
                            <div class="persona-stat">
                                <span class="persona-stat-value" id="persona7Obs">0</span>
                                <span class="persona-stat-label">Observations</span>
                            </div>
                            <div class="persona-stat">
                                <span class="persona-stat-value" id="persona7Time">0m</span>
                                <span class="persona-stat-label">Runtime</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="output" class="tab-content">
                <div class="output-section">
                    <div class="output-header">
                        <div class="output-title">
                            <span class="status-indicator status-offline" id="statusIndicator"></span>
                            Agent System Output
                        </div>
                        <button class="btn btn-secondary" onclick="clearOutput()">🗑️ Clear</button>
                    </div>
                    <div class="output-container" id="outputContainer">
                        <div class="output-line">💡 Welcome to MercadoLivre AI Agent Dashboard!</div>
                        <div class="output-line">🚀 Click "Run Enhanced Agents" to see detailed persona interactions</div>
                        <div class="output-line">📊 Click "Run Real Agents" to execute the actual Python system</div>
                        <div class="output-line">🎭 Click "Run Simulation" for a quick demo</div>
                        <div class="output-line">⚡ Ready to start your agent analysis...</div>
                    </div>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Agent system is running...</p>
                </div>
            </div>

            <div id="personas" class="tab-content">
                <h2>👥 Complete Persona Profiles & Behavioral Analysis</h2>
                <p style="text-align: center; margin-bottom: 30px; color: #666;">
                    Explore the detailed behavioral patterns and unique characteristics of all 7 MercadoLivre shopper personas
                </p>
                
                <div class="interaction-details">
                    <h3>🔬 Tech Enthusiast Persona</h3>
                    <div class="persona-summary">
                        <strong>Key Differentiator:</strong> Focuses on specifications, features, and performance comparisons. Values technical details over price.
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">💭 Key Questions Asked:</div>
                        <ul class="interaction-list">
                            <li>What are the technical specifications of this smartphone?</li>
                            <li>How does the camera quality compare to competitors?</li>
                            <li>What's the processor speed and RAM capacity?</li>
                            <li>Are there any user reviews about performance issues?</li>
                        </ul>
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">📋 Observed Behaviors:</div>
                        <ul class="interaction-list">
                            <li>Spent 4.2 minutes analyzing product specifications</li>
                            <li>Compared 6 similar products in the same category</li>
                            <li>Read 12 user reviews focusing on technical details</li>
                            <li>Analyzed price-to-performance ratio across 4 retailers</li>
                        </ul>
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">✅ Key Decisions Made:</div>
                        <ul class="interaction-list">
                            <li>Added high-end smartphone to wishlist after spec analysis</li>
                            <li>Decided against budget option due to insufficient RAM</li>
                            <li>Chose premium model for better camera specifications</li>
                        </ul>
                    </div>
                </div>

                <div class="interaction-details">
                    <h3>💰 Budget Shopper Persona</h3>
                    <div class="persona-summary">
                        <strong>Key Differentiator:</strong> Price-conscious, seeks deals, discounts, and best value options. Cost is the primary decision factor.
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">💭 Key Questions Asked:</div>
                        <ul class="interaction-list">
                            <li>What's the cheapest price available for this item?</li>
                            <li>Are there any current discounts or promotions?</li>
                            <li>How much would shipping cost to my location?</li>
                            <li>Is there a payment plan option available?</li>
                        </ul>
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">📋 Observed Behaviors:</div>
                        <ul class="interaction-list">
                            <li>Compared prices across 8 different sellers</li>
                            <li>Applied 3 different discount codes to find best deal</li>
                            <li>Calculated total cost including shipping and taxes</li>
                            <li>Evaluated cost per use over expected product lifetime</li>
                        </ul>
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">✅ Key Decisions Made:</div>
                        <ul class="interaction-list">
                            <li>Selected mid-range option with best value proposition</li>
                            <li>Waited for promotional period to maximize savings</li>
                            <li>Chose seller with free shipping to reduce total cost</li>
                        </ul>
                    </div>
                </div>

                <div class="interaction-details">
                    <h3>🎁 Gift Buyer Persona</h3>
                    <div class="persona-summary">
                        <strong>Key Differentiator:</strong> Purchases for others, values presentation and gift services. Focuses on recipient satisfaction over personal preferences.
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">💭 Key Questions Asked:</div>
                        <ul class="interaction-list">
                            <li>Is this item suitable as a gift for a teenager?</li>
                            <li>What gift wrapping options are available?</li>
                            <li>Can I schedule delivery for a specific date?</li>
                            <li>What's the return process for gift recipients?</li>
                        </ul>
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">📋 Observed Behaviors:</div>
                        <ul class="interaction-list">
                            <li>Browsed gift categories for 15 minutes</li>
                            <li>Checked age-appropriate ratings and reviews</li>
                            <li>Compared gift wrapping and personalization options</li>
                            <li>Read gift-giving guides and recommendations</li>
                        </ul>
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">✅ Key Decisions Made:</div>
                        <ul class="interaction-list">
                            <li>Selected popular electronics item based on age group</li>
                            <li>Added premium gift wrapping for special occasion</li>
                            <li>Scheduled delivery 2 days before birthday</li>
                        </ul>
                    </div>
                </div>

                <div class="interaction-details">
                    <h3>👨‍👩‍👧‍👦 Family Shopper Persona</h3>
                    <div class="persona-summary">
                        <strong>Key Differentiator:</strong> Buys for household needs, bulk purchases, safety-focused. Prioritizes family welfare and practical value.
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">💭 Key Questions Asked:</div>
                        <ul class="interaction-list">
                            <li>Is this product child-safe and non-toxic?</li>
                            <li>What's the bulk purchase discount for multiple units?</li>
                            <li>How durable is this for everyday family use?</li>
                            <li>What's the warranty coverage for household items?</li>
                        </ul>
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">📋 Observed Behaviors:</div>
                        <ul class="interaction-list">
                            <li>Researched safety certifications and age recommendations</li>
                            <li>Compared family pack sizes vs individual purchases</li>
                            <li>Read parent reviews focusing on durability and safety</li>
                            <li>Evaluated storage and space requirements for home</li>
                        </ul>
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">✅ Key Decisions Made:</div>
                        <ul class="interaction-list">
                            <li>Chose family-size package for better value</li>
                            <li>Selected products with extended warranty for peace of mind</li>
                            <li>Prioritized safety-certified items over cheaper alternatives</li>
                        </ul>
                    </div>
                </div>

                <div class="interaction-details">
                    <h3>🏢 Business Buyer Persona</h3>
                    <div class="persona-summary">
                        <strong>Key Differentiator:</strong> Professional purchases, bulk orders, B2B features needed. Focuses on efficiency, ROI, and business compliance.
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">💭 Key Questions Asked:</div>
                        <ul class="interaction-list">
                            <li>Are there bulk pricing tiers for large quantities?</li>
                            <li>What's the invoice and tax documentation process?</li>
                            <li>Is there a dedicated business customer support line?</li>
                            <li>Are there corporate account benefits available?</li>
                        </ul>
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">📋 Observed Behaviors:</div>
                        <ul class="interaction-list">
                            <li>Requested formal quotes for quantities over 50 units</li>
                            <li>Compared supplier ratings and delivery reliability</li>
                            <li>Evaluated total cost of ownership including maintenance</li>
                            <li>Reviewed vendor credentials and business certifications</li>
                        </ul>
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">✅ Key Decisions Made:</div>
                        <ul class="interaction-list">
                            <li>Selected enterprise-grade solution with support contract</li>
                            <li>Negotiated payment terms and bulk delivery schedule</li>
                            <li>Chose established vendor with proven business track record</li>
                        </ul>
                    </div>
                </div>

                <div class="interaction-details">
                    <h3>👴 Senior Shopper Persona</h3>
                    <div class="persona-summary">
                        <strong>Key Differentiator:</strong> Values simplicity, clear information, and customer support. Prefers traditional shopping methods and personal assistance.
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">💭 Key Questions Asked:</div>
                        <ul class="interaction-list">
                            <li>Is this product easy to use for someone my age?</li>
                            <li>How do I contact customer service if I need help?</li>
                            <li>What's the return policy if the product doesn't work?</li>
                            <li>Are there clear, large-print instructions included?</li>
                        </ul>
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">📋 Observed Behaviors:</div>
                        <ul class="interaction-list">
                            <li>Looked for large, clear product images and descriptions</li>
                            <li>Prioritized products with simple, intuitive interfaces</li>
                            <li>Checked for availability of phone-based customer support</li>
                            <li>Verified easy return process and clear contact information</li>
                        </ul>
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">✅ Key Decisions Made:</div>
                        <ul class="interaction-list">
                            <li>Selected products with excellent customer service ratings</li>
                            <li>Chose items with simple setup and clear instructions</li>
                            <li>Prioritized local sellers for easier returns if needed</li>
                        </ul>
                    </div>
                </div>

                <div class="interaction-details">
                    <h3>💎 Luxury Shopper Persona</h3>
                    <div class="persona-summary">
                        <strong>Key Differentiator:</strong> Premium quality focused, exclusive products, premium service. Values brand prestige and unique experiences over cost savings.
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">💭 Key Questions Asked:</div>
                        <ul class="interaction-list">
                            <li>What premium features distinguish this from standard models?</li>
                            <li>Is this an authentic, original product with warranty?</li>
                            <li>What exclusive or limited edition options are available?</li>
                            <li>Are there premium delivery and white-glove services?</li>
                        </ul>
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">📋 Observed Behaviors:</div>
                        <ul class="interaction-list">
                            <li>Focused on brand prestige and product exclusivity</li>
                            <li>Researched brand heritage and craftsmanship details</li>
                            <li>Compared luxury features and premium materials</li>
                            <li>Evaluated product as investment or status symbol</li>
                        </ul>
                    </div>
                    <div class="interaction-section">
                        <div class="interaction-title">✅ Key Decisions Made:</div>
                        <ul class="interaction-list">
                            <li>Selected top-tier model with premium features</li>
                            <li>Chose authorized dealers for authenticity guarantee</li>
                            <li>Added premium services like express delivery and setup</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="company" class="tab-content">
                <h2>🏢 Company Agent Analysis & Recommendations</h2>
                
                <div class="company-agents">
                    <h3>🔄 Interactive Agent Workflow</h3>
                    <p class="workflow-description">Our agents work together in a coordinated workflow to gather, process, and analyze shopper behavior.</p>

                    <div class="agent-workflow">
                        <div class="workflow-step">Step 1</div>
                        <div class="workflow-arrow">↓</div>
                    </div>

                    <div class="company-agent-card">
                        <div class="agent-name">🏢 Company Context Agent</div>
                        <div class="agent-work">
                            <strong>Market Analysis:</strong><br>
                            • Identified 3 key customer pain points in product discovery<br>
                            • Analyzed competitor pricing strategies across 12 major retailers<br>
                            • Mapped customer journey from search to purchase completion<br><br>
                            <strong>Context Provided to Feedback Collection Agent:</strong><br>
                            • Market positioning analysis for MercadoLivre<br>
                            • Competitor landscape and differentiation points<br>
                            • Target demographic analysis by product category
                        </div>
                    </div>

                    <div class="agent-workflow">
                        <div class="workflow-step">Step 2</div>
                        <div class="workflow-arrow">↓</div>
                    </div>

                    <div class="company-agent-card">
                        <div class="agent-name">🎙️ Feedback Collection Agent</div>
                        <div class="agent-work">
                            <strong>Research Conducted:</strong><br>
                            • Conducted interviews with 24 diverse shoppers across personas<br>
                            • Gathered survey responses from 120 MercadoLivre users<br>
                            • Documented feature requests and usability challenges<br><br>
                            <strong>Questions Asked to Personas:</strong><br>
                            • "How would you rate your overall satisfaction with the shopping experience?"<br>
                            • "What features were most difficult to use during your shopping?"<br>
                            • "Which product categories were most challenging to navigate?"
                        </div>
                    </div>

                    <div class="agent-workflow">
                        <div class="workflow-step">Step 3</div>
                        <div class="workflow-arrow">↓</div>
                    </div>

                    <div class="company-agent-card">
                        <div class="agent-name">📊 Data Agent</div>
                        <div class="agent-work">
                            <strong>Data Sources Processed:</strong><br>
                            • Feedback Collection Agent interview transcripts<br>
                            • Company Context Agent market analysis reports<br>
                            • User behavior tracking data from the platform<br><br>
                            <strong>Key Insights Generated:</strong><br>
                            • Tech enthusiasts have 34% higher conversion on detailed product pages<br>
                            • Budget shoppers respond 67% better to time-limited promotions<br>
                            • Gift buyers prefer curated collections over broad categories
                        </div>
                    </div>
                </div>

                <style>
                    .workflow-description {
                        text-align: center;
                        margin-bottom: 20px;
                        color: #555;
                        font-size: 16px;
                    }

                    .agent-workflow {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        margin: 15px 0;
                    }

                    .workflow-step {
                        background: rgba(255, 255, 255, 0.2);
                        padding: 5px 15px;
                        border-radius: 20px;
                        font-weight: 600;
                        font-size: 14px;
                        color: white;
                    }

                    .workflow-arrow {
                        font-size: 24px;
                        margin: 5px 0;
                        color: rgba(255, 255, 255, 0.7);
                    }
                </style>
            </div>

            <div id="surveys" class="tab-content">
                <h2>📋 Complete Survey Results</h2>
                <p class="survey-description">Access all 120 survey responses collected by the Feedback Collection Agent</p>

                <div class="survey-controls">
                    <div class="survey-filters">
                        <label for="personaFilter">Filter by Persona Type:</label>
                        <select id="personaFilter" onchange="filterSurveys()">
                            <option value="all">All Personas</option>
                            <option value="tech_enthusiast">Tech Enthusiast</option>
                            <option value="budget_shopper">Budget Shopper</option>
                            <option value="gift_buyer">Gift Buyer</option>
                            <option value="family_shopper">Family Shopper</option>
                            <option value="business_buyer">Business Buyer</option>
                            <option value="senior_shopper">Senior Shopper</option>
                            <option value="luxury_shopper">Luxury Shopper</option>
                        </select>

                        <label for="questionFilter">Filter by Question:</label>
                        <select id="questionFilter" onchange="filterSurveys()">
                            <option value="all">All Questions</option>
                        </select>
                    </div>

                    <button class="btn btn-secondary" onclick="loadSurveyData()">
                        🔄 Refresh Data
                    </button>
                </div>

                <div class="survey-metrics">
                    <div class="metric-card">
                        <span class="metric-value" id="totalSurveys">280</span>
                        <span class="metric-label">Total Surveys</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value" id="techSurveys">0</span>
                        <span class="metric-label">Tech Enthusiasts</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value" id="budgetSurveys">0</span>
                        <span class="metric-label">Budget Shoppers</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value" id="giftSurveys">0</span>
                        <span class="metric-label">Gift Buyers</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value" id="familySurveys">0</span>
                        <span class="metric-label">Family Shoppers</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value" id="businessSurveys">0</span>
                        <span class="metric-label">Business Buyers</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value" id="seniorSurveys">0</span>
                        <span class="metric-label">Senior Shoppers</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value" id="luxurySurveys">0</span>
                        <span class="metric-label">Luxury Shoppers</span>
                    </div>
                </div>

                <div class="loading" id="surveyLoading">
                    <div class="spinner"></div>
                    <p>Loading survey data...</p>
                </div>

                <div class="survey-results" id="surveyResults">
                    <div class="survey-table-container">
                        <table class="survey-table">
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Persona Type</th>
                                    <th>Question</th>
                                    <th>Response</th>
                                    <th>Time Spent</th>
                                    <th>Device</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody id="surveyTableBody">
                                <!-- Survey data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <style>
                    .survey-description {
                        text-align: center;
                        margin-bottom: 20px;
                        color: #555;
                        font-size: 16px;
                    }

                    .survey-controls {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                    }

                    .survey-filters {
                        display: flex;
                        gap: 15px;
                        align-items: center;
                    }

                    .survey-filters label {
                        margin-right: 5px;
                        font-weight: 600;
                    }

                    .survey-filters select {
                        padding: 8px 12px;
                        border-radius: 6px;
                        border: 1px solid #ddd;
                        background-color: white;
                    }

                    .survey-table-container {
                        max-height: 600px;
                        overflow-y: auto;
                        margin-top: 20px;
                        background: white;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                    }

                    .survey-table {
                        width: 100%;
                        border-collapse: collapse;
                    }

                    .survey-table th {
                        position: sticky;
                        top: 0;
                        background: #f0f2f5;
                        padding: 12px 15px;
                        text-align: left;
                        font-weight: 600;
                        color: #333;
                        border-bottom: 1px solid #ddd;
                    }

                    .survey-table td {
                        padding: 10px 15px;
                        border-bottom: 1px solid #eee;
                        color: #333;
                    }

                    .survey-table tr:hover {
                        background-color: #f9f9f9;
                    }

                    .tech_enthusiast {
                        background-color: rgba(33, 150, 243, 0.1);
                    }

                    .budget_shopper {
                        background-color: rgba(76, 175, 80, 0.1);
                    }

                    .gift_buyer {
                        background-color: rgba(244, 67, 54, 0.1);
                    }
                </style>
            </div>

            <div id="insights" class="tab-content">
                <h2>🧠 AI-Powered Insights</h2>
                <p class="insights-description">Advanced analysis and recommendations generated from survey data</p>

                <div class="insights-controls">
                    <div class="insights-filters">
                        <label for="departmentFilter">View by Department:</label>
                        <select id="departmentFilter" onchange="filterInsights()">
                            <option value="all">All Departments</option>
                            <option value="Product & Design">Product & Design</option>
                            <option value="Finance & Pricing">Finance & Pricing</option>
                            <option value="Catalog Management">Catalog Management</option>
                            <option value="Payments & Transactions">Payments & Transactions</option>
                            <option value="Logistics & Delivery">Logistics & Delivery</option>
                            <option value="Customer Experience">Customer Experience</option>
                            <option value="Mobile Development">Mobile Development</option>
                        </select>

                        <label for="categoryFilter">View by Category:</label>
                        <select id="categoryFilter" onchange="filterInsights()">
                            <option value="all">All Categories</option>
                            <option value="ui_ux">UI/UX</option>
                            <option value="pricing_transparency">Pricing Transparency</option>
                            <option value="product_information">Product Information</option>
                            <option value="checkout_payment">Checkout & Payment</option>
                            <option value="delivery_logistics">Delivery & Logistics</option>
                            <option value="gifting_experience">Gifting Experience</option>
                            <option value="mobile_experience">Mobile Experience</option>
                        </select>
                    </div>

                    <button class="btn btn-secondary" onclick="loadAIInsights()">
                        🧠 Analyze Data
                    </button>
                </div>

                <div class="loading" id="insightsLoading">
                    <div class="spinner"></div>
                    <p>AI is analyzing survey responses...</p>
                </div>

                <div class="insights-summary" id="insightsSummary">
                    <h3>📊 Overall Insights</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <div class="insight-header">
                                <h4>Response Distribution</h4>
                            </div>
                            <div class="distribution-bars" id="personaDistribution">
                                <!-- Distribution bars will be added here -->
                            </div>
                        </div>

                        <div class="insight-card">
                            <div class="insight-header">
                                <h4>Top Categories</h4>
                            </div>
                            <div class="category-list" id="topCategories">
                                <!-- Top categories will be added here -->
                            </div>
                        </div>

                        <div class="insight-card wide-card">
                            <div class="insight-header">
                                <h4>Key Findings</h4>
                            </div>
                            <ul class="finding-list" id="keyFindings">
                                <!-- Key findings will be added here -->
                            </ul>
                        </div>

                        <div class="insight-card wide-card">
                            <div class="insight-header">
                                <h4>Priority Recommendations</h4>
                            </div>
                            <ul class="recommendations-list" id="priorityRecommendations">
                                <!-- Priority recommendations will be added here -->
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="department-insights" id="departmentInsights">
                    <h3>🏢 Department-Specific Insights</h3>
                    <div class="department-cards" id="departmentCards">
                        <!-- Department cards will be added here -->
                    </div>
                </div>

                <div class="category-insights" id="categoryInsights">
                    <h3>🔍 Category-Specific Insights</h3>
                    <div class="category-cards" id="categoryCards">
                        <!-- Category cards will be added here -->
                    </div>
                </div>

                <div class="sentiment-analysis" id="sentimentAnalysis">
                    <h3>😊 Sentiment Analysis by Persona</h3>
                    <div class="sentiment-grid" id="sentimentGrid">
                        <!-- Sentiment analysis will be added here -->
                    </div>
                </div>

                <style>
                    .insights-description {
                        text-align: center;
                        margin-bottom: 20px;
                        color: #555;
                        font-size: 16px;
                    }

                    .insights-controls {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                    }

                    .insights-filters {
                        display: flex;
                        gap: 15px;
                        align-items: center;
                    }

                    .insights-filters label {
                        margin-right: 5px;
                        font-weight: 600;
                    }

                    .insights-filters select {
                        padding: 8px 12px;
                        border-radius: 6px;
                        border: 1px solid #ddd;
                        background-color: white;
                    }

                    .insights-grid {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 20px;
                        margin-bottom: 30px;
                    }

                    .insight-card {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                    }

                    .wide-card {
                        grid-column: span 2;
                    }

                    .insight-header {
                        margin-bottom: 15px;
                        padding-bottom: 10px;
                        border-bottom: 1px solid #eee;
                    }

                    .insight-header h4 {
                        margin: 0;
                        color: #333;
                        font-size: 18px;
                    }

                    .distribution-bars {
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                    }

                    .distribution-bar {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }

                    .bar-label {
                        width: 120px;
                        font-size: 14px;
                    }

                    .bar-container {
                        flex-grow: 1;
                        height: 20px;
                        background: #f0f2f5;
                        border-radius: 10px;
                        overflow: hidden;
                    }

                    .bar-fill {
                        height: 100%;
                        border-radius: 10px;
                    }

                    .bar-fill.tech_enthusiast {
                        background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
                    }

                    .bar-fill.budget_shopper {
                        background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
                    }

                    .bar-fill.gift_buyer {
                        background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%);
                    }

                    .bar-value {
                        width: 40px;
                        text-align: right;
                        font-weight: 600;
                    }

                    .category-list {
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                    }

                    .category-item {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 8px 12px;
                        background: #f9f9f9;
                        border-radius: 6px;
                    }

                    .category-name {
                        font-weight: 600;
                    }

                    .category-count {
                        background: #667eea;
                        color: white;
                        padding: 2px 8px;
                        border-radius: 12px;
                        font-size: 12px;
                    }

                    .finding-list, .recommendations-list {
                        padding-left: 20px;
                    }

                    .finding-list li, .recommendations-list li {
                        margin-bottom: 12px;
                        line-height: 1.5;
                    }

                    .department-cards, .category-cards {
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                        gap: 20px;
                        margin-bottom: 30px;
                    }

                    .department-card, .category-card {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                    }

                    .department-card h4, .category-card h4 {
                        margin-top: 0;
                        margin-bottom: 15px;
                        padding-bottom: 10px;
                        border-bottom: 1px solid #eee;
                    }

                    .insight-count {
                        background: #667eea;
                        color: white;
                        padding: 2px 8px;
                        border-radius: 12px;
                        font-size: 12px;
                        margin-left: 10px;
                    }

                    .department-label {
                        font-size: 14px;
                        color: #666;
                        margin-bottom: 10px;
                    }

                    .persona-distribution-mini {
                        margin: 15px 0;
                    }

                    .mini-bar {
                        height: 8px;
                        background: #f0f2f5;
                        border-radius: 4px;
                        overflow: hidden;
                        display: flex;
                    }

                    .mini-bar-fill {
                        height: 100%;
                    }

                    .mini-bar-fill.tech_enthusiast {
                        background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
                    }

                    .mini-bar-fill.budget_shopper {
                        background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
                    }

                    .mini-bar-fill.gift_buyer {
                        background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%);
                    }

                    .sentiment-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                        gap: 20px;
                        margin-bottom: 30px;
                    }

                    .sentiment-card {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                    }

                    .sentiment-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 15px;
                        padding-bottom: 10px;
                        border-bottom: 1px solid #eee;
                    }

                    .sentiment-score {
                        font-size: 24px;
                        font-weight: 700;
                    }

                    .positive-score {
                        color: #4CAF50;
                    }

                    .neutral-score {
                        color: #FFC107;
                    }

                    .negative-score {
                        color: #F44336;
                    }

                    .sentiment-persona-list {
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                    }

                    .sentiment-persona-item {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                    }

                    .sentiment-persona-name {
                        font-weight: 500;
                    }

                    .sentiment-persona-value {
                        font-weight: 600;
                    }
                </style>
            </div>
        </div>
    </div>

    <script>
        let currentStream = null;
        let startTime = null;
        let timerInterval = null;
        let insightsData = null;
        let selectedDepartment = 'all';
        let selectedCategory = 'all';
        let evtSource = null; // Server-Sent Events source

        function switchTab(tabName) {
            console.log("Switching to tab:", tabName);
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            } else {
                console.error("Tab content not found:", tabName);
            }

            // Add active class to clicked tab
            // Use the global event if available, otherwise find the tab by its onclick attribute
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                const clickedTab = document.querySelector(`.tab[onclick*="'${tabName}'"]`);
                if (clickedTab) {
                    clickedTab.classList.add('active');
                }
            }

            // If switching to insights tab, load data if not already loaded
            if (tabName === 'insights' && !insightsData) {
                setTimeout(() => loadAIInsights(), 100);
            }
        }

        // Server-Sent Events connection
        function connectSSE() {
            console.log("Connecting to SSE events...");
            if (evtSource) {
                console.log("Closing existing SSE connection");
                evtSource.close();
            }

            evtSource = new EventSource('/events');

            evtSource.onopen = function() {
                console.log("SSE connection opened");
                addOutput("Connected to server events", "info");
            };

            evtSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('SSE event received:', data);

                    if (data.type === 'agent_update') {
                        updateAgentStatus(data);
                    } else if (data.type === 'survey_update') {
                        updateSurveyData(data);
                    } else {
                        console.log("Unknown event type:", data.type);
                    }
                } catch (e) {
                    console.error("Error parsing SSE message:", e, event.data);
                }
            };

            evtSource.onerror = function(error) {
                console.error('SSE connection error', error);
                addOutput("Server connection error. Reconnecting...", "error");
                setTimeout(connectSSE, 3000);
            };
        }

        // Updates from SSE events
        function updateAgentStatus(data) {
            console.log("Agent status update:", data);
            // Implementation will depend on the data format
        }

        function updateSurveyData(data) {
            console.log("Survey data update:", data);
            // Add to survey data
            if (data.survey) {
                allSurveyData.push(data.survey);
                filterSurveys();
            }
        }

        function addOutput(message, type = '') {
            const container = document.getElementById('outputContainer');
            const line = document.createElement('div');
            line.className = `output-line ${type}`;

            // Add timestamp
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;

            container.appendChild(line);
            container.scrollTop = container.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('outputContainer').innerHTML = '';
            addOutput('Output cleared', 'info');
        }

        function updateStatus(status, message) {
            const indicator = document.getElementById('statusIndicator');
            const loading = document.getElementById('loading');
            
            indicator.className = `status-indicator status-${status}`;
            
            if (status === 'running') {
                loading.classList.add('active');
            } else {
                loading.classList.remove('active');
            }
            
            if (message) {
                addOutput(message, status === 'online' ? 'success' : status === 'offline' ? 'error' : 'info');
            }
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('runtime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updatePersonaStatus(personaNum, status, observations = null, time = null) {
            const statusElement = document.getElementById(`persona${personaNum}Status`);
            if (statusElement) {
                statusElement.textContent = status;
                statusElement.className = `persona-status status-${status.toLowerCase()}`;
            }
            
            if (observations !== null) {
                const obsElement = document.getElementById(`persona${personaNum}Obs`);
                if (obsElement) {
                    obsElement.textContent = observations;
                }
            }
            if (time !== null) {
                const timeElement = document.getElementById(`persona${personaNum}Time`);
                if (timeElement) {
                    timeElement.textContent = time;
                }
            }
        }

        function setButtonsDisabled(disabled) {
            document.getElementById('runAllBtn').disabled = disabled;
            document.getElementById('stopBtn').disabled = !disabled;
        }

        async function runAllAgents() {
            console.log("Running AI agent analysis...");
            if (currentStream) {
                console.log("Stream already exists, returning");
                return;
            }

            setButtonsDisabled(true);
            updateStatus('running', 'Starting MercadoLivre Agent Analysis...');
            addOutput('🚀 Starting AI Agent analysis system...', 'info');
            startTimer();

            try {
                console.log("Attempting to connect to backend...");
                let response;
                try {
                    response = await fetch('/run-clean-agents', { method: 'POST' });
                    console.log("Response received:", response.status);

                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                } catch (apiError) {
                    console.log('Backend not available, running demo simulation');
                    return runDemoSimulation();
                }

                if (!response.body) {
                    throw new Error("Response body is null");
                }

                const reader = response.body.getReader();
                currentStream = reader;

                let activePersonas = 0;
                document.getElementById('activePersonas').textContent = activePersonas;
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const text = new TextDecoder().decode(value);
                    const lines = text.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const message = line.substring(6);
                            if (message.trim()) {
                                addOutput(message);
                                
                                // Update persona status based on output
                                if (message.includes('Tech Enthusiast Agent Starting')) {
                                    updatePersonaStatus(1, 'active');
                                    activePersonas = 1;
                                } else if (message.includes('Budget Shopper Agent Starting')) {
                                    updatePersonaStatus(2, 'active');
                                    activePersonas = 1;
                                } else if (message.includes('Gift Buyer Agent Starting')) {
                                    updatePersonaStatus(3, 'active');
                                    activePersonas = 1;
                                } else if (message.includes('Total Observations:')) {
                                    const obsMatch = message.match(/Total Observations: (\d+)/);
                                    if (obsMatch) {
                                        const totalObs = parseInt(document.getElementById('totalObservations').textContent) + parseInt(obsMatch[1]);
                                        document.getElementById('totalObservations').textContent = totalObs;
                                    }
                                } else if (message.includes('COMPLETE')) {
                                    updatePersonaStatus(1, 'completed');
                                    updatePersonaStatus(2, 'completed');
                                    updatePersonaStatus(3, 'completed');
                                    activePersonas = 0;
                                }
                                
                                document.getElementById('activePersonas').textContent = activePersonas;
                            }
                        }
                    }
                }
                
                updateStatus('online', 'Enhanced agent analysis completed successfully!');
            } catch (error) {
                console.error("Error in runCleanAgents:", error);
                updateStatus('offline', `Error: ${error.message}`);
                addOutput(`⚠️ Error running agents: ${error.message}`, 'error');
            } finally {
                currentStream = null;
                setButtonsDisabled(false);
                stopTimer();
                console.log("runCleanAgents completed");
            }
        }

        async function runAgents() {
            if (currentStream) return;
            
            setButtonsDisabled(true);
            updateStatus('running', 'Starting Real MercadoLivre Agent System...');
            startTimer();
            
            try {
                const response = await fetch('/run-agents', { method: 'POST' });
                const reader = response.body.getReader();
                currentStream = reader;
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const text = new TextDecoder().decode(value);
                    const lines = text.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const message = line.substring(6);
                            if (message.trim()) {
                                addOutput(message);
                            }
                        }
                    }
                }
                
                updateStatus('online', 'Real agent system completed!');
            } catch (error) {
                updateStatus('offline', `Error: ${error.message}`);
            } finally {
                currentStream = null;
                setButtonsDisabled(false);
                stopTimer();
            }
        }

        async function runSimulation() {
            if (currentStream) return;
            
            setButtonsDisabled(true);
            updateStatus('running', 'Starting Agent Simulation...');
            startTimer();
            
            try {
                const response = await fetch('/run-simulation', { method: 'POST' });
                const reader = response.body.getReader();
                currentStream = reader;
                
                let activePersonas = 0;
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const text = new TextDecoder().decode(value);
                    const lines = text.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const message = line.substring(6);
                            if (message.trim()) {
                                addOutput(message);
                                
                                // Update UI based on simulation phases
                                if (message.includes('Phase 4')) {
                                    updatePersonaStatus(1, 'active');
                                    updatePersonaStatus(2, 'active');
                                    updatePersonaStatus(3, 'active');
                                    activePersonas = 3;
                                    document.getElementById('activePersonas').textContent = activePersonas;
                                } else if (message.includes('observations')) {
                                    const obsMatch = message.match(/(\d+) observations/);
                                    if (obsMatch) {
                                        const totalObs = parseInt(document.getElementById('totalObservations').textContent) + parseInt(obsMatch[1]);
                                        document.getElementById('totalObservations').textContent = totalObs;
                                    }
                                } else if (message.includes('COMPLETE')) {
                                    updatePersonaStatus(1, 'completed');
                                    updatePersonaStatus(2, 'completed');
                                    updatePersonaStatus(3, 'completed');
                                    activePersonas = 0;
                                    document.getElementById('activePersonas').textContent = activePersonas;
                                }
                            }
                        }
                    }
                }
                
                updateStatus('online', 'Simulation completed successfully!');
            } catch (error) {
                updateStatus('offline', `Error: ${error.message}`);
            } finally {
                currentStream = null;
                setButtonsDisabled(false);
                stopTimer();
            }
        }

        async function stopAgents() {
            if (currentStream) {
                await currentStream.cancel();
                currentStream = null;
            }
            
            try {
                await fetch('/stop', { method: 'POST' });
                updateStatus('offline', 'Agent system stopped');
            } catch (error) {
                updateStatus('offline', `Error stopping system: ${error.message}`);
            }
            
            setButtonsDisabled(false);
            stopTimer();
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing dashboard...");
            updateStatus('offline', 'Dashboard loaded. Ready to start agent analysis.');

            // Initialize survey data
            loadSurveyData();

            // Initialize insights components
            document.getElementById('insightsSummary').style.display = 'none';
            document.getElementById('departmentInsights').style.display = 'none';
            document.getElementById('categoryInsights').style.display = 'none';
            document.getElementById('sentimentAnalysis').style.display = 'none';
            document.getElementById('insightsLoading').style.display = 'none';

            // Set up filter change handlers
            document.getElementById('departmentFilter').addEventListener('change', function() {
                filterInsights();
            });

            document.getElementById('categoryFilter').addEventListener('change', function() {
                filterInsights();
            });

            // Set up button event handlers
            console.log("Setting up button event handlers...");

            const runAllButton = document.getElementById('runAllBtn');
            if (runAllButton) {
                runAllButton.addEventListener('click', function() {
                    console.log("Run All button clicked");
                    runAllAgents();
                });
                console.log("Run All button handler attached");
            } else {
                console.error("Run All button not found");
            }

            const stopButton = document.getElementById('stopBtn');
            if (stopButton) {
                stopButton.addEventListener('click', function() {
                    console.log("Stop button clicked");
                    stopAgents();
                });
                console.log("Stop button handler attached");
            } else {
                console.error("Stop button not found");
            }

            // Add tab change event handlers
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                const tabName = tab.getAttribute('data-tab');
                if (tabName) {
                    // Add click event listener
                    tab.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log("Tab clicked:", tabName);
                        switchTab(tabName);

                        // Auto-load insights data when insights tab is clicked
                        if (tabName === 'insights' && !insightsData) {
                            console.log("Auto-loading insights data");
                            setTimeout(() => loadAIInsights(), 100);
                        }
                    });
                    console.log(`Tab handler attached for ${tabName}`);
                }
            });

            // Special handler for insights tab was added during the tab setup above
            // No need for additional handling here since all tabs now use event listeners

            // Connect to server events
            console.log("Setting up SSE connection...");
            try {
                connectSSE();
                console.log("SSE connection established");
            } catch (e) {
                console.error("Error connecting to SSE:", e);
                addOutput('⚠️ Error connecting to server events: ' + e.message, 'error');
            }

            addOutput('🧠 AI analysis system ready', 'info');
            console.log("Dashboard initialization complete");
        });

        async function runDemoSimulation() {
            console.log("Running demo simulation...");
            updateStatus('running', 'Running demo simulation...');
            addOutput('🎬 Running demo simulation (backend not available)', 'info');
            
            const demoMessages = [
                '🚀 Initializing MercadoLivre AI Agent Analysis System...',
                '📊 Setting up 7 persona simulation environment...',
                '🔬 Tech Enthusiast Agent: Analyzing smartphone specifications...',
                '💰 Budget Shopper Agent: Searching for discount opportunities...',
                '🎁 Gift Buyer Agent: Exploring gift wrapping options...',
                '👨‍👩‍👧‍👦 Family Shopper Agent: Checking safety certifications...',
                '🏢 Business Buyer Agent: Evaluating bulk purchase options...',
                '👴 Senior Shopper Agent: Reviewing customer support quality...',
                '💎 Luxury Shopper Agent: Examining premium product lines...',
                '📈 Analyzing 1,247 customer interactions across all personas...',
                '🧠 AI processing complete - insights generated for all 7 personas',
                '✅ Demo simulation completed successfully!'
            ];

            let activePersonas = 7;
            document.getElementById('activePersonas').textContent = activePersonas;

            for (let i = 0; i < demoMessages.length; i++) {
                const message = demoMessages[i];
                addOutput(message, 'info');
                
                // Update persona status
                if (i >= 2 && i <= 8) {
                    updatePersonaStatus(i - 1, 'active', Math.floor(Math.random() * 50) + 10, `${Math.floor(Math.random() * 5) + 2}m`);
                }
                
                // Update total observations
                if (i === 9) {
                    document.getElementById('totalObservations').textContent = '1247';
                }
                
                // Complete personas at the end
                if (i === demoMessages.length - 1) {
                    for (let p = 1; p <= 7; p++) {
                        updatePersonaStatus(p, 'completed');
                    }
                    activePersonas = 0;
                    document.getElementById('activePersonas').textContent = activePersonas;
                }
                
                await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second delay between messages
            }
            
            updateStatus('online', 'Demo simulation completed successfully!');
        }

        // Survey Data Functions
        let allSurveyData = [];
        let questionOptions = [];

        function getMockSurveyData() {
            return {
                survey_count: 280,
                surveys: [
                    {
                        user_id: "demo_001",
                        persona_type: "tech_enthusiast",
                        responses: {
                            "What features are most important to you in a smartphone?": "High-performance processor, advanced camera system, 5G connectivity",
                            "How do you research products before buying?": "Read technical specifications, compare benchmarks, check expert reviews"
                        },
                        time_spent_minutes: 8,
                        device: "Desktop",
                        timestamp: "2024-01-15T10:30:00Z"
                    },
                    {
                        user_id: "demo_002", 
                        persona_type: "budget_shopper",
                        responses: {
                            "What factors influence your purchase decisions?": "Price, discounts, value for money, customer reviews",
                            "How often do you compare prices?": "Always compare prices across multiple platforms before buying"
                        },
                        time_spent_minutes: 12,
                        device: "Mobile",
                        timestamp: "2024-01-15T11:15:00Z"
                    },
                    {
                        user_id: "demo_003",
                        persona_type: "gift_buyer", 
                        responses: {
                            "What makes a good gift?": "Beautiful presentation, gift wrapping options, thoughtful selection",
                            "How do you choose gifts?": "Consider recipient's preferences, look for unique items, check delivery options"
                        },
                        time_spent_minutes: 15,
                        device: "Tablet",
                        timestamp: "2024-01-15T14:20:00Z"
                    },
                    {
                        user_id: "demo_004",
                        persona_type: "family_shopper",
                        responses: {
                            "What are your priorities when shopping?": "Safety, bulk buying options, family-friendly products",
                            "How do you manage household purchases?": "Plan ahead, buy in bulk, focus on quality and durability"
                        },
                        time_spent_minutes: 10,
                        device: "Desktop",
                        timestamp: "2024-01-15T16:45:00Z"
                    },
                    {
                        user_id: "demo_005",
                        persona_type: "business_buyer",
                        responses: {
                            "What drives your business purchases?": "ROI, scalability, vendor support, integration capabilities",
                            "How do you evaluate suppliers?": "Check references, test products, negotiate terms, assess support"
                        },
                        time_spent_minutes: 20,
                        device: "Desktop", 
                        timestamp: "2024-01-15T09:30:00Z"
                    },
                    {
                        user_id: "demo_006",
                        persona_type: "senior_shopper",
                        responses: {
                            "What makes shopping easy for you?": "Simple navigation, clear descriptions, good customer service",
                            "What are your main concerns?": "Product reliability, easy returns, trusted brands"
                        },
                        time_spent_minutes: 18,
                        device: "Desktop",
                        timestamp: "2024-01-15T13:10:00Z"
                    },
                    {
                        user_id: "demo_007",
                        persona_type: "luxury_shopper",
                        responses: {
                            "What defines luxury for you?": "Premium quality, exclusive designs, exceptional service",
                            "How do you choose luxury items?": "Brand reputation, craftsmanship, uniqueness, personal service"
                        },
                        time_spent_minutes: 25,
                        device: "Mobile",
                        timestamp: "2024-01-15T15:00:00Z"
                    }
                ]
            };
        }

        async function loadSurveyData() {
            document.getElementById('surveyLoading').classList.add('active');
            document.getElementById('surveyResults').style.display = 'none';

            try {
                let data;
                try {
                    const response = await fetch('/survey-data');
                    if (!response.ok) throw new Error('API not available');
                    data = await response.json();
                } catch (apiError) {
                    console.log('Using mock survey data for demo');
                    data = getMockSurveyData();
                }

                allSurveyData = [];

                // Process survey data
                data.surveys.forEach(survey => {
                    const personaType = survey.persona_type;

                    Object.entries(survey.responses).forEach(([question, response]) => {
                        allSurveyData.push({
                            userId: survey.user_id,
                            personaType: personaType,
                            question: question,
                            response: response,
                            timeSpent: survey.time_spent_minutes,
                            device: survey.device,
                            timestamp: survey.timestamp
                        });

                        // Add unique questions to question filter
                        if (!questionOptions.includes(question)) {
                            questionOptions.push(question);
                        }
                    });
                });

                // Populate question filter
                const questionFilter = document.getElementById('questionFilter');
                questionFilter.innerHTML = '<option value="all">All Questions</option>';

                questionOptions.forEach(question => {
                    const shortQuestion = question.length > 40 ? question.substring(0, 40) + '...' : question;
                    const option = document.createElement('option');
                    option.value = question;
                    option.textContent = shortQuestion;
                    questionFilter.appendChild(option);
                });

                // Update metrics
                const techCount = data.surveys.filter(s => s.persona_type === 'tech_enthusiast').length;
                const budgetCount = data.surveys.filter(s => s.persona_type === 'budget_shopper').length;
                const giftCount = data.surveys.filter(s => s.persona_type === 'gift_buyer').length;
                const familyCount = data.surveys.filter(s => s.persona_type === 'family_shopper').length;
                const businessCount = data.surveys.filter(s => s.persona_type === 'business_buyer').length;
                const seniorCount = data.surveys.filter(s => s.persona_type === 'senior_shopper').length;
                const luxuryCount = data.surveys.filter(s => s.persona_type === 'luxury_shopper').length;

                document.getElementById('totalSurveys').textContent = data.survey_count;
                document.getElementById('techSurveys').textContent = techCount;
                document.getElementById('budgetSurveys').textContent = budgetCount;
                document.getElementById('giftSurveys').textContent = giftCount;
                document.getElementById('familySurveys').textContent = familyCount;
                document.getElementById('businessSurveys').textContent = businessCount;
                document.getElementById('seniorSurveys').textContent = seniorCount;
                document.getElementById('luxurySurveys').textContent = luxuryCount;

                // Display data
                filterSurveys();

            } catch (error) {
                console.error('Error loading survey data:', error);
                document.getElementById('surveyTableBody').innerHTML =
                    `<tr><td colspan="7">Error loading survey data: ${error.message}</td></tr>`;
            } finally {
                document.getElementById('surveyLoading').classList.remove('active');
                document.getElementById('surveyResults').style.display = 'block';
            }
        }

        function filterSurveys() {
            const personaFilter = document.getElementById('personaFilter').value;
            const questionFilter = document.getElementById('questionFilter').value;

            let filteredData = [...allSurveyData];

            // Apply filters
            if (personaFilter !== 'all') {
                filteredData = filteredData.filter(item => item.personaType === personaFilter);
            }

            if (questionFilter !== 'all') {
                filteredData = filteredData.filter(item => item.question === questionFilter);
            }

            // Sort by timestamp (newest first)
            filteredData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Limit to first 100 for performance
            const displayData = filteredData.slice(0, 100);

            // Render table
            const tableBody = document.getElementById('surveyTableBody');
            tableBody.innerHTML = '';

            if (displayData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7">No survey data matching the selected filters</td></tr>';
                return;
            }

            displayData.forEach(item => {
                const row = document.createElement('tr');
                row.className = item.personaType;

                row.innerHTML = `
                    <td>${item.userId}</td>
                    <td>${item.personaType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</td>
                    <td>${item.question}</td>
                    <td>${item.response}</td>
                    <td>${item.timeSpent} min</td>
                    <td>${item.device}</td>
                    <td>${item.timestamp}</td>
                `;

                tableBody.appendChild(row);
            });

            if (filteredData.length > 100) {
                const noteRow = document.createElement('tr');
                noteRow.innerHTML = `<td colspan="7" style="text-align: center; font-style: italic;">
                    Showing 100 of ${filteredData.length} matching survey responses. Apply filters to see more specific results.
                </td>`;
                tableBody.appendChild(noteRow);
            }
        }

        // AI Insights Functions (insightsData declared earlier)

        function getMockInsightsData() {
            return {
                overall: {
                    total_responses: 280,
                    response_distribution: {
                        "tech_enthusiast": 45,
                        "budget_shopper": 52,
                        "gift_buyer": 38,
                        "family_shopper": 42,
                        "business_buyer": 35,
                        "senior_shopper": 41,
                        "luxury_shopper": 27
                    },
                    top_categories: [
                        ["Electronics", 89],
                        ["Fashion", 67],
                        ["Home & Garden", 54],
                        ["Sports", 45],
                        ["Books", 25]
                    ],
                    key_findings: [
                        "Tech enthusiasts spend 40% more time researching before purchase",
                        "Budget shoppers are 3x more likely to abandon cart without discounts",
                        "Luxury shoppers value personalized service over fast delivery",
                        "Family shoppers prioritize safety certifications and bulk options"
                    ],
                    priority_recommendations: [
                        "Create persona-specific landing pages to improve conversion",
                        "Implement dynamic pricing strategies based on persona behavior",
                        "Develop targeted email campaigns for each persona type",
                        "Optimize mobile experience for budget and gift buyer personas"
                    ]
                },
                by_department: [
                    {
                        name: "Product",
                        response_count: 95,
                        key_insights: [
                            "Tech enthusiasts drive 60% of feature requests",
                            "Luxury shoppers want premium material options",
                            "Family shoppers need safety certifications"
                        ],
                        priority_recommendations: [
                            "Prioritize advanced camera features for tech enthusiasts",
                            "Develop premium product lines for luxury segment",
                            "Add detailed safety information for family shoppers"
                        ]
                    },
                    {
                        name: "Marketing",
                        response_count: 87,
                        key_insights: [
                            "Budget shoppers respond 70% better to discount messaging",
                            "Gift buyers prefer seasonal campaigns",
                            "Business buyers need ROI-focused content"
                        ],
                        priority_recommendations: [
                            "Create discount-focused campaigns for budget segment",
                            "Launch holiday gift guides and promotions",
                            "Develop case studies for business buyers"
                        ]
                    },
                    {
                        name: "Customer Service",
                        response_count: 98,
                        key_insights: [
                            "Senior shoppers require more support touchpoints",
                            "Tech enthusiasts prefer self-service options",
                            "Luxury shoppers expect white-glove service"
                        ],
                        priority_recommendations: [
                            "Expand senior customer support hours",
                            "Create detailed FAQ and video tutorials",
                            "Implement VIP support tier for luxury customers"
                        ]
                    }
                ],
                by_category: {
                    electronics: {
                        department: "Product",
                        dominant_personas: ["tech_enthusiast", "business_buyer"],
                        pain_points: [
                            "Complex technical specifications are hard to understand",
                            "Limited comparison tools between similar products",
                            "Unclear warranty and support information"
                        ],
                        opportunities: [
                            "Create interactive specification comparison tools",
                            "Add expert video reviews and demonstrations",
                            "Simplify warranty information presentation"
                        ]
                    },
                    fashion: {
                        department: "Marketing",
                        dominant_personas: ["luxury_shopper", "gift_buyer"],
                        pain_points: [
                            "Size guides are inconsistent across brands",
                            "Limited styling advice and recommendations",
                            "Return policy concerns for online purchases"
                        ],
                        opportunities: [
                            "Implement virtual try-on technology",
                            "Create personalized style recommendations",
                            "Offer hassle-free return guarantees"
                        ]
                    }
                },
                sentiment_analysis: {
                    overall_sentiment: 0.72,
                    by_persona: {
                        "tech_enthusiast": 0.78,
                        "budget_shopper": 0.65,
                        "gift_buyer": 0.82,
                        "family_shopper": 0.71,
                        "business_buyer": 0.69,
                        "senior_shopper": 0.75,
                        "luxury_shopper": 0.88
                    },
                    trending_topics: [
                        { topic: "Fast delivery", sentiment: 0.85, mentions: 234 },
                        { topic: "Product quality", sentiment: 0.73, mentions: 189 },
                        { topic: "Customer service", sentiment: 0.68, mentions: 156 },
                        { topic: "Pricing", sentiment: 0.62, mentions: 143 },
                        { topic: "User interface", sentiment: 0.77, mentions: 98 }
                    ]
                }
            };
        }

        async function loadAIInsights() {
            // Show loading spinner
            document.getElementById('insightsSummary').style.display = 'none';
            document.getElementById('departmentInsights').style.display = 'none';
            document.getElementById('categoryInsights').style.display = 'none';
            document.getElementById('sentimentAnalysis').style.display = 'none';
            document.getElementById('insightsLoading').style.display = 'block';

            // Update agent status to show AI analysis is running
            updateStatus('running', '🧠 AI analysis system is processing survey data...');

            // Show Data Agent as active in the workflow
            const dataAgentCard = document.querySelector('.company-agent-card:nth-child(6)');
            if (dataAgentCard) {
                dataAgentCard.style.background = 'linear-gradient(135deg, #FF6B35 0%, #F7931E 100%)';
                dataAgentCard.style.boxShadow = '0 4px 20px rgba(255, 107, 53, 0.4)';
            }

            try {
                // Fetch insights from AI analysis endpoint
                let data;
                try {
                    const response = await fetch('/ai-analysis');
                    if (!response.ok) throw new Error('API not available');
                    data = await response.json();
                } catch (apiError) {
                    console.log('Using mock insights data for demo');
                    data = getMockInsightsData();
                }
                insightsData = data;

                // Render the insights
                renderOverallInsights(insightsData.overall);
                renderDepartmentInsights(insightsData.by_department);
                renderCategoryInsights(insightsData.by_category);
                renderSentimentAnalysis(insightsData.sentiment_analysis);

                // Apply filters if needed
                filterInsights();

                // Show the insights sections
                document.getElementById('insightsSummary').style.display = 'block';
                document.getElementById('departmentInsights').style.display = 'block';
                document.getElementById('categoryInsights').style.display = 'block';
                document.getElementById('sentimentAnalysis').style.display = 'block';

                // Log successful analysis
                addOutput('🧠 AI analysis completed successfully', 'success');
                updateStatus('online', 'AI analysis completed');

                // Return Data Agent card to normal state
                if (dataAgentCard) {
                    setTimeout(() => {
                        dataAgentCard.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
                        dataAgentCard.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
                    }, 2000);
                }

            } catch (error) {
                console.error('Error loading AI insights:', error);
                addOutput(`⚠️ AI analysis failed: ${error.message}`, 'error');
                updateStatus('offline', 'AI analysis error');
                alert('Failed to load AI insights. Please try again.');

                // Return Data Agent card to normal state
                if (dataAgentCard) {
                    dataAgentCard.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
                    dataAgentCard.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
                }
            } finally {
                // Hide loading spinner
                document.getElementById('insightsLoading').style.display = 'none';
            }
        }

        function renderOverallInsights(overall) {
            // Render response distribution
            const personaDistribution = document.getElementById('personaDistribution');
            personaDistribution.innerHTML = '';

            const personaTypes = Object.keys(overall.response_distribution);
            const maxCount = Math.max(...Object.values(overall.response_distribution));

            personaTypes.forEach(persona => {
                const count = overall.response_distribution[persona];
                const percentage = Math.round((count / overall.total_responses) * 100);

                const barItem = document.createElement('div');
                barItem.className = 'distribution-bar';

                const formattedPersona = persona.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());

                barItem.innerHTML = `
                    <div class="bar-label">${formattedPersona}</div>
                    <div class="bar-container">
                        <div class="bar-fill ${persona}" style="width: ${percentage}%"></div>
                    </div>
                    <div class="bar-value">${count}</div>
                `;

                personaDistribution.appendChild(barItem);
            });

            // Render top categories
            const topCategories = document.getElementById('topCategories');
            topCategories.innerHTML = '';

            overall.top_categories.forEach(([category, count]) => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';

                const formattedCategory = category.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());

                categoryItem.innerHTML = `
                    <div class="category-name">${formattedCategory}</div>
                    <div class="category-count">${count}</div>
                `;

                topCategories.appendChild(categoryItem);
            });

            // Render key findings
            const keyFindings = document.getElementById('keyFindings');
            keyFindings.innerHTML = '';

            overall.key_findings.forEach(finding => {
                const li = document.createElement('li');
                li.textContent = finding;
                keyFindings.appendChild(li);
            });

            // Render priority recommendations
            const priorityRecommendations = document.getElementById('priorityRecommendations');
            priorityRecommendations.innerHTML = '';

            overall.priority_recommendations.forEach(recommendation => {
                const li = document.createElement('li');
                li.textContent = recommendation;
                priorityRecommendations.appendChild(li);
            });
        }

        function renderDepartmentInsights(departments) {
            const departmentCards = document.getElementById('departmentCards');
            departmentCards.innerHTML = '';

            departments.forEach(dept => {
                const card = document.createElement('div');
                card.className = 'department-card';
                card.dataset.department = dept.name;

                let insightsHtml = '<ul class="department-insights-list">';
                dept.key_insights.forEach(insight => {
                    insightsHtml += `<li>${insight}</li>`;
                });
                insightsHtml += '</ul>';

                let recommendationsHtml = '<ul class="department-recommendations-list">';
                dept.priority_recommendations.forEach(rec => {
                    recommendationsHtml += `<li>${rec}</li>`;
                });
                recommendationsHtml += '</ul>';

                card.innerHTML = `
                    <h4>${dept.name} <span class="insight-count">${dept.response_count}</span></h4>
                    <div class="department-content">
                        <h5>Key Insights:</h5>
                        ${insightsHtml}
                        <h5>Priority Recommendations:</h5>
                        ${recommendationsHtml}
                    </div>
                `;

                departmentCards.appendChild(card);
            });
        }

        function renderCategoryInsights(categories) {
            const categoryCards = document.getElementById('categoryCards');
            categoryCards.innerHTML = '';

            Object.entries(categories).forEach(([categoryKey, category]) => {
                const card = document.createElement('div');
                card.className = 'category-card';
                card.dataset.category = categoryKey;
                card.dataset.department = category.department;

                let painPointsHtml = '<ul class="category-painpoints-list">';
                category.pain_points.forEach(point => {
                    painPointsHtml += `<li>${point}</li>`;
                });
                painPointsHtml += '</ul>';

                let recommendationsHtml = '<ul class="category-recommendations-list">';
                category.recommendations.forEach(rec => {
                    recommendationsHtml += `<li>${rec}</li>`;
                });
                recommendationsHtml += '</ul>';

                // Calculate persona distribution percentages
                const techPercentage = Math.round(category.persona_distribution.tech_enthusiast * 100);
                const budgetPercentage = Math.round(category.persona_distribution.budget_shopper * 100);
                const giftPercentage = Math.round(category.persona_distribution.gift_buyer * 100);

                card.innerHTML = `
                    <h4>${category.name} <span class="insight-count">${category.response_count}</span></h4>
                    <div class="department-label">Department: ${category.department}</div>
                    <div class="persona-distribution-mini">
                        <div class="mini-bar">
                            <div class="mini-bar-fill tech_enthusiast" style="width: ${techPercentage}%" title="Tech Enthusiast: ${techPercentage}%"></div>
                            <div class="mini-bar-fill budget_shopper" style="width: ${budgetPercentage}%" title="Budget Shopper: ${budgetPercentage}%"></div>
                            <div class="mini-bar-fill gift_buyer" style="width: ${giftPercentage}%" title="Gift Buyer: ${giftPercentage}%"></div>
                        </div>
                    </div>
                    <h5>Pain Points:</h5>
                    ${painPointsHtml}
                    <h5>Recommendations:</h5>
                    ${recommendationsHtml}
                `;

                categoryCards.appendChild(card);
            });
        }

        function renderSentimentAnalysis(sentiment) {
            const sentimentGrid = document.getElementById('sentimentGrid');
            sentimentGrid.innerHTML = '';

            Object.entries(sentiment).forEach(([category, personaSentiment]) => {
                const card = document.createElement('div');
                card.className = 'sentiment-card';
                card.dataset.category = category;

                const formattedCategory = category.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());

                // Calculate overall sentiment score for this category
                let totalScore = 0;
                let totalCount = 0;

                Object.values(personaSentiment).forEach(sentiment => {
                    if (sentiment.count > 0) {
                        totalScore += sentiment.sentiment_score * sentiment.count;
                        totalCount += sentiment.count;
                    }
                });

                const overallScore = totalCount > 0 ? totalScore / totalCount : 0;
                const scoreClass = overallScore > 0.2 ? 'positive-score' :
                                 overallScore < -0.2 ? 'negative-score' : 'neutral-score';
                const formattedScore = (overallScore * 100).toFixed(0);

                let personaListHtml = '<div class="sentiment-persona-list">';
                Object.entries(personaSentiment).forEach(([persona, data]) => {
                    if (data.count > 0) {
                        const personaScoreClass = data.sentiment_score > 0.2 ? 'positive-score' :
                                               data.sentiment_score < -0.2 ? 'negative-score' : 'neutral-score';
                        const formattedPersonaScore = (data.sentiment_score * 100).toFixed(0);

                        const formattedPersona = persona.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());

                        personaListHtml += `
                            <div class="sentiment-persona-item">
                                <span class="sentiment-persona-name">${formattedPersona}</span>
                                <span class="sentiment-persona-value ${personaScoreClass}">${formattedPersonaScore}</span>
                            </div>
                        `;
                    }
                });
                personaListHtml += '</div>';

                card.innerHTML = `
                    <div class="sentiment-header">
                        <h4>${formattedCategory}</h4>
                        <span class="sentiment-score ${scoreClass}">${formattedScore}</span>
                    </div>
                    ${personaListHtml}
                `;

                sentimentGrid.appendChild(card);
            });
        }

        function filterInsights() {
            if (!insightsData) return;

            const departmentFilter = document.getElementById('departmentFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;

            // Update global filter values
            selectedDepartment = departmentFilter;
            selectedCategory = categoryFilter;

            // Filter department cards
            const departmentCards = document.querySelectorAll('.department-card');
            let visibleDepartments = 0;

            departmentCards.forEach(card => {
                if (departmentFilter === 'all' || card.dataset.department === departmentFilter) {
                    card.style.display = 'block';
                    visibleDepartments++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Filter category cards
            const categoryCards = document.querySelectorAll('.category-card');
            let visibleCategories = 0;

            categoryCards.forEach(card => {
                const showByDepartment = departmentFilter === 'all' || card.dataset.department === departmentFilter;
                const showByCategory = categoryFilter === 'all' || card.dataset.category === categoryFilter;

                if (showByDepartment && showByCategory) {
                    card.style.display = 'block';
                    visibleCategories++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Filter sentiment cards
            const sentimentCards = document.querySelectorAll('.sentiment-card');
            let visibleSentiment = 0;

            sentimentCards.forEach(card => {
                if (categoryFilter === 'all' || card.dataset.category === categoryFilter) {
                    card.style.display = 'block';
                    visibleSentiment++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Add filter status message
            const departmentSection = document.getElementById('departmentInsights');
            const categorySection = document.getElementById('categoryInsights');
            const sentimentSection = document.getElementById('sentimentAnalysis');

            // Update headers with filter information
            if (departmentFilter !== 'all') {
                departmentSection.querySelector('h3').textContent = `🏢 Department Insights: ${departmentFilter} (${visibleDepartments})`;
            } else {
                departmentSection.querySelector('h3').textContent = `🏢 Department-Specific Insights`;
            }

            if (categoryFilter !== 'all') {
                const formattedCategory = categoryFilter.replace('_', ' ').replace(/\b\w/g, c => c.toUpperCase());
                categorySection.querySelector('h3').textContent = `🔍 Category Insights: ${formattedCategory} (${visibleCategories})`;
            } else {
                categorySection.querySelector('h3').textContent = `🔍 Category-Specific Insights`;
            }

            // Log filter application
            if (departmentFilter !== 'all' || categoryFilter !== 'all') {
                addOutput(`🔍 Applied filters - Department: ${departmentFilter === 'all' ? 'All' : departmentFilter}, Category: ${categoryFilter === 'all' ? 'All' : categoryFilter.replace('_', ' ')}`, 'info');
            }
        }
    </script>
</body>
</html> 